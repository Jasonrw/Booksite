CREATE TABLE "WRITER" (
    "ID" NUMBER(11) NOT NULL PRIMARY KEY,
    "NAME" NVARCHAR2(50),
    "INTRO" NCLOB
)
;

DECLARE
    i INTEGER;
BEGIN
    SELECT COUNT(*) INTO i FROM USER_CATALOG
        WHERE TABLE_NAME = 'WRITER_SQ' AND TABLE_TYPE = 'SEQUENCE';
    IF i = 0 THEN
        EXECUTE IMMEDIATE 'CREATE SEQUENCE "WRITER_SQ"';
    END IF;
END;
/

CREATE OR REPLACE TRIGGER "WRITER_TR"
BEFORE INSERT ON "WRITER"
FOR EACH ROW
WHEN (new."ID" IS NULL)
    BEGIN
        SELECT "WRITER_SQ".nextval
        INTO :new."ID" FROM dual;
    END;
/
CREATE TABLE "PRESS" (
    "ID" NUMBER(11) NOT NULL PRIMARY KEY,
    "NAME" NVARCHAR2(100),
    "INTRO" NCLOB,
    "SITE" NVARCHAR2(200)
)
;

DECLARE
    i INTEGER;
BEGIN
    SELECT COUNT(*) INTO i FROM USER_CATALOG
        WHERE TABLE_NAME = 'PRESS_SQ' AND TABLE_TYPE = 'SEQUENCE';
    IF i = 0 THEN
        EXECUTE IMMEDIATE 'CREATE SEQUENCE "PRESS_SQ"';
    END IF;
END;
/

CREATE OR REPLACE TRIGGER "PRESS_TR"
BEFORE INSERT ON "PRESS"
FOR EACH ROW
WHEN (new."ID" IS NULL)
    BEGIN
        SELECT "PRESS_SQ".nextval
        INTO :new."ID" FROM dual;
    END;
/
CREATE TABLE "TAG" (
    "NAME" NVARCHAR2(50) NOT NULL PRIMARY KEY,
    "ADD_TIME" TIMESTAMP NOT NULL,
    "INTRO" NCLOB
)
;
CREATE TABLE "BOOK_TAG" (
    "ID" NUMBER(11) NOT NULL PRIMARY KEY,
    "BOOK_ID" NVARCHAR2(13) NOT NULL,
    "TAG_ID" NVARCHAR2(50) NOT NULL REFERENCES "TAG" ("NAME") DEFERRABLE INITIALLY DEFERRED,
    UNIQUE ("BOOK_ID", "TAG_ID")
)
;

DECLARE
    i INTEGER;
BEGIN
    SELECT COUNT(*) INTO i FROM USER_CATALOG
        WHERE TABLE_NAME = 'BOOK_TAG_SQ' AND TABLE_TYPE = 'SEQUENCE';
    IF i = 0 THEN
        EXECUTE IMMEDIATE 'CREATE SEQUENCE "BOOK_TAG_SQ"';
    END IF;
END;
/

CREATE OR REPLACE TRIGGER "BOOK_TAG_TR"
BEFORE INSERT ON "BOOK_TAG"
FOR EACH ROW
WHEN (new."ID" IS NULL)
    BEGIN
        SELECT "BOOK_TAG_SQ".nextval
        INTO :new."ID" FROM dual;
    END;
/
CREATE TABLE "BOOK" (
    "ISBN" NVARCHAR2(13) NOT NULL PRIMARY KEY,
    "NAME" NVARCHAR2(200),
    "WRITER_ID" NUMBER(11) NOT NULL REFERENCES "WRITER" ("ID") DEFERRABLE INITIALLY DEFERRED,
    "PRESS_ID" NUMBER(11) NOT NULL REFERENCES "PRESS" ("ID") DEFERRABLE INITIALLY DEFERRED,
    "DATE" TIMESTAMP NOT NULL,
    "INTRO" NCLOB,
    "COVER" NVARCHAR2(100),
    "SCORE" DOUBLE PRECISION,
    "VOTE" NUMBER(11),
    "ADD_TIME" TIMESTAMP NOT NULL
)
;
ALTER TABLE "BOOK_TAG" ADD CONSTRAINT "BOOK_ID_REFS_ISBN_AAD4CBF3" FOREIGN KEY ("BOOK_ID") REFERENCES "BOOK" ("ISBN") DEFERRABLE INITIALLY DEFERRED;
CREATE TABLE "COMMENT" (
    "ID" NUMBER(11) NOT NULL PRIMARY KEY,
    "USER_ID" NUMBER(11) NOT NULL REFERENCES "AUTH_USER" ("ID") DEFERRABLE INITIALLY DEFERRED,
    "BOOK_ID" NVARCHAR2(13) NOT NULL REFERENCES "BOOK" ("ISBN") DEFERRABLE INITIALLY DEFERRED,
    "TITLE" NVARCHAR2(30),
    "CONTENT" NCLOB,
    "ADD_TIME" TIMESTAMP NOT NULL,
    UNIQUE ("USER_ID", "BOOK_ID")
)
;

DECLARE
    i INTEGER;
BEGIN
    SELECT COUNT(*) INTO i FROM USER_CATALOG
        WHERE TABLE_NAME = 'COMMENT_SQ' AND TABLE_TYPE = 'SEQUENCE';
    IF i = 0 THEN
        EXECUTE IMMEDIATE 'CREATE SEQUENCE "COMMENT_SQ"';
    END IF;
END;
/

CREATE OR REPLACE TRIGGER "COMMENT_TR"
BEFORE INSERT ON "COMMENT"
FOR EACH ROW
WHEN (new."ID" IS NULL)
    BEGIN
        SELECT "COMMENT_SQ".nextval
        INTO :new."ID" FROM dual;
    END;
/
CREATE INDEX "BOOK_0BD0423A" ON "BOOK" ("WRITER_ID");
CREATE INDEX "BOOK_2E87E430" ON "BOOK" ("PRESS_ID");
CREATE INDEX "COMMENT_6340C63C" ON "COMMENT" ("USER_ID");
CREATE INDEX "COMMENT_36C249D7" ON "COMMENT" ("BOOK_ID");

COMMIT;
