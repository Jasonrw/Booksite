CREATE TABLE "WRITER" (
    "ID" NUMBER(11) NOT NULL PRIMARY KEY,
    "NAME" NVARCHAR2(50),
    "INTRO" NCLOB,
    "PHOTO" NVARCHAR2(100)
)
;

DECLARE
    i INTEGER;
BEGIN
    SELECT COUNT(*) INTO i FROM USER_CATALOG
        WHERE TABLE_NAME = 'WRITER_SQ' AND TABLE_TYPE = 'SEQUENCE';
    IF i = 0 THEN
        EXECUTE IMMEDIATE 'CREATE SEQUENCE "WRITER_SQ"';
    END IF;
END;
/

CREATE OR REPLACE TRIGGER "WRITER_TR"
BEFORE INSERT ON "WRITER"
FOR EACH ROW
WHEN (new."ID" IS NULL)
    BEGIN
        SELECT "WRITER_SQ".nextval
        INTO :new."ID" FROM dual;
    END;
/
CREATE TABLE "PRESS" (
    "ID" NUMBER(11) NOT NULL PRIMARY KEY,
    "NAME" NVARCHAR2(100),
    "INTRO" NCLOB,
    "SITE" NVARCHAR2(200)
)
;

DECLARE
    i INTEGER;
BEGIN
    SELECT COUNT(*) INTO i FROM USER_CATALOG
        WHERE TABLE_NAME = 'PRESS_SQ' AND TABLE_TYPE = 'SEQUENCE';
    IF i = 0 THEN
        EXECUTE IMMEDIATE 'CREATE SEQUENCE "PRESS_SQ"';
    END IF;
END;
/

CREATE OR REPLACE TRIGGER "PRESS_TR"
BEFORE INSERT ON "PRESS"
FOR EACH ROW
WHEN (new."ID" IS NULL)
    BEGIN
        SELECT "PRESS_SQ".nextval
        INTO :new."ID" FROM dual;
    END;
/
CREATE TABLE "CATEGORY" (
    "NAME" NVARCHAR2(50) NOT NULL PRIMARY KEY,
    "INTRO" NCLOB
)
;
CREATE TABLE "BOOK" (
    "ISBN" NVARCHAR2(13) NOT NULL PRIMARY KEY,
    "NAME" NVARCHAR2(200),
    "WRITER_ID" NUMBER(11) NOT NULL REFERENCES "WRITER" ("ID") DEFERRABLE INITIALLY DEFERRED,
    "PRESS_ID" NUMBER(11) NOT NULL REFERENCES "PRESS" ("ID") DEFERRABLE INITIALLY DEFERRED,
    "DATE" DATE NOT NULL,
    "INTRO" NCLOB,
    "COVER" NVARCHAR2(100),
    "SCORE" DOUBLE PRECISION,
    "ADD_TIME" TIMESTAMP NOT NULL
)
;
CREATE TABLE "COMMENT" (
    "USER_ID" NUMBER(11) NOT NULL PRIMARY KEY,
    "BOOK_ID" NVARCHAR2(13) NOT NULL PRIMARY KEY REFERENCES "BOOK" ("ISBN") DEFERRABLE INITIALLY DEFERRED,
    "COMMENT" NCLOB,
    "ADD_TIME" TIMESTAMP NOT NULL
)
;
-- The following references should be added but depend on non-existent tables:
-- ALTER TABLE "COMMENT" ADD CONSTRAINT "USER_ID_REFS_ID_4D5BD902" FOREIGN KEY ("USER_ID") REFERENCES "AUTH_USER" ("ID") DEFERRABLE INITIALLY DEFERRED;
CREATE INDEX "BOOK_0BD0423A" ON "BOOK" ("WRITER_ID");
CREATE INDEX "BOOK_2E87E430" ON "BOOK" ("PRESS_ID");

COMMIT;
